<script>
    // Configura√ß√µes e Estado 
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJ2qAnh6Eul-Qasgc-wVfjgaqF5bsnoS8tm2Kjwt7XZ4CPZGqUlEFbZYnIIxQX-3DRyA/exec";
    
    // üåü ALTERA√á√ÉO: Esta lista fixa √© agora apenas para o bot√£o "Todos" e ordem preferencial, mas n√£o √© obrigat√≥ria.
    // Usaremos as categorias lidas dos dados.
    let uniqueCategories = []; // Armazenar√° as categorias √∫nicas da Sheet

    let productCatalogue = []; // Armazena todos os produtos carregados
    // O carrinho agora armazena { productIndex: count, ... }
    let cart = {};              
    let currentFilter = 'Todos'; // O filtro de categoria ativo

    // Elementos DOM
    const elements = {
        gallery: document.getElementById('productGallery'),
        cartCount: document.getElementById('cartCount'),
        loadingMessage: document.getElementById('loadingMessage'),
        errorMessage: document.getElementById('errorMessage'),
        scriptUrlDisplay: document.getElementById('scriptUrlDisplay'),
        catalogueSection: document.getElementById('catalogueSection'),
        orderSection: document.getElementById('orderSection'),
        viewOrderForm: document.getElementById('viewOrderForm'),
        orderForm: document.getElementById('orderForm'),
        selectedProductsSummary: document.getElementById('selectedProductsSummary'),
        produtosSelecionadosInput: document.getElementById('produtosSelecionadosInput'),
        quantidadeInput: document.getElementById('quantidade'),
        submitButton: document.getElementById('submitButton'),
        messageBox: document.getElementById('messageBox'),
        lightboxOverlay: document.getElementById('lightboxOverlay'),
        lightboxImage: document.getElementById('lightboxImage'),
        lightboxName: document.getElementById('lightboxName'),
        lightboxPrice: document.getElementById('lightboxPrice'),
        backToCatalogue: document.getElementById('backToCatalogue'),
        loaderOverlay: document.getElementById('loaderOverlay'), 
        filterContainer: document.getElementById('filterContainer')
    };

    /**
     * Exibe uma mensagem de notifica√ß√£o (Toast).
     * @param {string} message - A mensagem a exibir.
     * @param {string} type - 'success' ou 'error'.
     */
    function showMessage(message, type = 'success') {
        const box = elements.messageBox;
        box.textContent = message;
        box.className = 'show';
        
        // Define cor de fundo
        box.style.backgroundColor = type === 'success' ? '#10B981' : '#EF4444'; 

        // Esconde a mensagem ap√≥s 3 segundos
        setTimeout(() => {
            box.className = box.className.replace("show", "");
        }, 3000);
    }

    /**
     * Tenta fazer fetch com retries e espera exponencial (backoff).
     */
    async function fetchWithRetry(url, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return response;
                }
            } catch (error) {
                console.warn(`Tentativa ${i + 1} de fetch falhou: ${error.message}. A tentar novamente em breve...`);
            }
            if (i < retries - 1) {
                await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
            }
        }
        throw new Error("Falha ao buscar o recurso ap√≥s v√°rias tentativas.");
    }


    /**
     * Simplesmente devolve o URL.
     */
    function getDirectImageUrl(url) {
        return url;
    }

    /**
     * Fun√ß√£o de verifica√ß√£o robusta para o estado "Vendido".
     */
    function isProductSold(value) {
        if (value === true) return true;
        if (typeof value === 'string') {
            const upperValue = value.toUpperCase().trim();
            return upperValue === 'TRUE' || upperValue === 'SIM' || upperValue === '1';
        }
        return false;
    }
    
    /**
     * üåü ALTERA√á√ÉO: Determina a categoria de exibi√ß√£o de um produto com base na coluna 'Category'.
     */
    function getDisplayCategory(product) {
        // Usa o valor da coluna 'Category' diretamente.
        // Se a coluna estiver vazia, retorna 'Outros'.
        return (product.Category || 'Outros').trim(); 
    }


    /**
     * Valida e ajusta a quantidade inserida, e atualiza o carrinho se o item j√° estiver selecionado.
     */
    function validateQty(inputElement, productIndex) {
        let value = parseInt(inputElement.value);
        // Garante que o valor √© um n√∫mero e >= 1
        if (isNaN(value) || value < 1) {
            value = 1;
        } else if (value > 99) { 
            value = 99; // Limite m√°ximo para evitar spam
        }
        inputElement.value = value;
        
        // Se o item J√Å estiver no carrinho, atualiza a quantidade imediatamente
        if ((cart[productIndex] || 0) > 0) {
            cart[productIndex] = value;
            updateCartDisplay();
        }
    }

    /**
     * Configura os listeners para os bot√µes de incremento/decremento da quantidade.
     */
    function setupQuantityControls() {
        document.querySelectorAll('.qty-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation(); // Previne que o clique dispare o Lightbox

                const productIndex = parseInt(e.currentTarget.dataset.id);
                const action = e.currentTarget.dataset.action;
                const input = document.getElementById(`qty-${productIndex}`);
                let currentQty = parseInt(input.value);

                if (action === 'increment') {
                    currentQty = Math.min(currentQty + 1, 99);
                } else if (action === 'decrement') {
                    currentQty = Math.max(currentQty - 1, 1);
                }
                
                input.value = currentQty;
                
                // Se o item J√Å est√° selecionado, atualiza o carrinho e notifica
                if ((cart[productIndex] || 0) > 0) {
                     cart[productIndex] = currentQty;
                     updateCartDisplay();
                     showMessage(`Qtd. de ${productCatalogue[productIndex].Name} atualizada para ${currentQty}.`, 'success');
                }
            });
        });
    }


    /**
     * Adiciona ou remove um item do carrinho, usando a quantidade do input.
     */
    function handleSelectionClick(productIndex) {
        const product = productCatalogue[productIndex];
        
        if (isProductSold(product.Vendido)) {
            showMessage(`Este item est√° vendido e n√£o pode ser encomendado.`, 'error');
            return; 
        }

        const currentCount = cart[productIndex] || 0;
        const qtyInput = document.getElementById(`qty-${productIndex}`);
        // Garante que o input √© validado antes de ser usado
        validateQty(qtyInput, productIndex);
        const selectedQty = parseInt(qtyInput.value) || 1; 

        if (currentCount === 0) {
            // Se n√£o estava selecionado, adiciona com a quantidade escolhida
            cart[productIndex] = selectedQty;
            showMessage(`Produto ${product.Name} adicionado (x${selectedQty}).`, 'success');
        } else {
            // Se j√° estava selecionado, remove
            delete cart[productIndex]; 
            showMessage(`Produto ${product.Name} removido.`, 'error');
            // Resetar input para 1 ap√≥s remo√ß√£o para pr√≥xima sele√ß√£o
            qtyInput.value = 1; 
        }
        
        updateCartDisplay(); 
    }

    /**
     * Atualiza o estado visual de um √∫nico cart√£o (borda, sombra, √≠cone de pisco).
     */
    function updateCardState(index) {
        const cardElement = document.getElementById(`product-card-${index}`);
        const iconElement = document.getElementById(`select-icon-${index}`);
        // A sele√ß√£o agora √© determinada se a contagem for > 0
        const isSelected = (cart[index] || 0) > 0;

        if (cardElement) {
            cardElement.classList.toggle('selected', isSelected);
        }

        if (iconElement) {
            iconElement.classList.toggle('selected', isSelected);
            iconElement.innerHTML = isSelected 
                                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polyline points="20 6 9 17 4 12"></polyline></svg>` 
                                : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`;
        }
    }

    /**
     * Atualiza a exibi√ß√£o da contagem do carrinho e o resumo do formul√°rio.
     */
    function updateCartDisplay() {
        let totalCount = 0;
        let summaryHTML = '';
        let selectedProductNames = [];

        productCatalogue.forEach((product, index) => {
            const count = cart[index] || 0;
            
            // Atualiza o estado visual do cart√£o
            updateCardState(index); 

            if (count > 0) {
                totalCount += count;
                summaryHTML += `<p>‚Ä¢ ${product.Name} (x${count})</p>`;
                selectedProductNames.push(`${product.Name} (x${count})`);
            }
        });
        
        // 2. Atualiza os elementos globais
        elements.cartCount.textContent = totalCount;
        elements.quantidadeInput.value = totalCount;
        elements.produtosSelecionadosInput.value = selectedProductNames.join('; ');
        
        if (totalCount === 0) {
            summaryHTML = `<p class="text-red-600 font-medium">O seu carrinho est√° vazio. Volte ao cat√°logo para adicionar produtos.</p>`;
            elements.submitButton.disabled = true;
        } else {
             elements.submitButton.disabled = false;
        }
        
        elements.selectedProductsSummary.innerHTML = summaryHTML;
        
        // NUNCA Chamar filterAndRender aqui. Apenas em filter/init.
    }

    /**
     * Abre o modal de lightbox com a pr√©-visualiza√ß√£o.
     */
    function openLightbox(productIndex) {
        const product = productCatalogue[productIndex];
        if (!product) return;

        // Formata√ß√£o do pre√ßo com verifica√ß√£o de NaN
        const formattedPrice = isNaN(parseFloat(product.Price)) 
            ? "Pre√ßo Indispon√≠vel" 
            : `${parseFloat(product.Price).toFixed(2)} ‚Ç¨`;

        const imageUrl = getDirectImageUrl(product.ImageFile);

        elements.lightboxImage.src = imageUrl;
        // Define a imagem de fallback em caso de erro de carregamento (URL inv√°lido)
        elements.lightboxImage.onerror = () => {
             elements.lightboxImage.classList.add('image-fallback');
             elements.lightboxImage.src = "https://placehold.co/400x300/e0e0e0/777?text=Imagem+Indispon√≠vel";
        };
        elements.lightboxName.textContent = product.Name;
        elements.lightboxPrice.textContent = formattedPrice;
        
        elements.lightboxOverlay.style.display = 'flex';
    }

    /**
     * Fecha o modal de lightbox.
     */
    function closeLightbox() {
        elements.lightboxOverlay.style.display = 'none';
        elements.lightboxImage.classList.remove('image-fallback');
    }

    /**
     * Define o filtro ativo e renderiza a galeria.
     */
    function setFilter(filterName) {
        currentFilter = filterName;
        filterAndRender();
        
        // Atualizar estado ativo dos bot√µes
        document.querySelectorAll('#filterContainer button').forEach(button => {
            button.classList.remove('active');
            if (button.textContent.trim() === filterName) {
                button.classList.add('active');
            }
        });
    }
    
    /**
     * Filtra o cat√°logo de produtos e renderiza a galeria.
     */
    function filterAndRender() {
        let productsToRender;
        
        if (currentFilter === 'Todos') {
            productsToRender = productCatalogue;
        } else {
            // Filtra pelo valor exato da categoria
            productsToRender = productCatalogue.filter(product => {
                return getDisplayCategory(product) === currentFilter;
            });
        }

        renderGallery(productsToRender);
        // Re-anexar os listeners do controle de quantidade ap√≥s a renderiza√ß√£o
        setupQuantityControls(); 
        // Atualiza o estado visual, pois o filtro pode ter mudado
        updateCartDisplay(); 
    }
    
    /**
     * üåü ALTERA√á√ÉO: Gera e renderiza os bot√µes de filtro de categoria (usando a lista din√¢mica).
     */
    function renderFilterButtons() {
        elements.filterContainer.innerHTML = ``;

        // 1. Adicionar o bot√£o "Todos" (sempre presente)
        const allButton = document.createElement('button');
        allButton.textContent = 'Todos';
        allButton.className = 'filter-button bg-white text-indigo-600 border border-indigo-300 px-4 py-2 rounded-full font-semibold hover:bg-indigo-50 transition duration-150';
        allButton.onclick = () => setFilter('Todos');
        if (currentFilter === 'Todos') {
            allButton.classList.add('active');
        }
        elements.filterContainer.appendChild(allButton);

        // 2. Adicionar os bot√µes das categorias √∫nicas da Sheet
        uniqueCategories.forEach(category => {
            const button = document.createElement('button');
            button.textContent = category;
            button.className = 'filter-button bg-white text-indigo-600 border border-indigo-300 px-4 py-2 rounded-full font-semibold hover:bg-indigo-50 transition duration-150';
            button.onclick = () => setFilter(category);
            
            if (category === currentFilter) {
                button.classList.add('active');
            }
            
            elements.filterContainer.appendChild(button);
        });
    }

    /**
     * Renderiza a galeria de produtos.
     */
    function renderGallery(products) {
        if (products.length === 0) {
             elements.gallery.innerHTML = `<p class="col-span-full text-center text-xl text-gray-500 p-10 bg-gray-50 rounded-lg shadow-inner">
                N√£o existem produtos na categoria **${currentFilter}**.
             </p>`;
             return;
        }

        elements.gallery.innerHTML = products.map((product, index) => {
            // Encontra o √≠ndice original no cat√°logo completo
            const originalIndex = productCatalogue.findIndex(p => p.Name === product.Name);
            const isSold = isProductSold(product.Vendido);
            const isSelected = (cart[originalIndex] || 0) > 0;
            const formattedPrice = isNaN(parseFloat(product.Price)) ? "N/A" : `${parseFloat(product.Price).toFixed(2)} ‚Ç¨`;
            
            // Oculta os produtos que est√£o vendidos (mas mant√©m o cart√£o na estrutura)
            const cardVisibility = isSold && currentFilter !== 'Todos' ? 'opacity-50' : '';
            // Se o produto est√° vendido, desativa o bot√£o de sele√ß√£o
            const selectionDisabled = isSold ? 'disabled' : '';

            return `
                <div id="product-card-${originalIndex}" 
                     class="product-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] relative ${cardVisibility} ${isSelected ? 'selected' : ''}" 
                     data-index="${originalIndex}"
                     onclick="openLightbox(${originalIndex})">
                    
                    ${isSold ? '<div class="sold-ribbon">VENDIDO</div>' : ''}

                    <div class="square-image-container">
                        <img src="${getDirectImageUrl(product.ImageFile)}" 
                             alt="${product.Name}" 
                             class="rounded-t-xl"
                             onerror="this.onerror=null; this.src='https://placehold.co/400x400/e0e0e0/777?text=Imagem+Indispon√≠vel'; this.classList.add('image-fallback');">
                    </div>

                    <div class="p-3 sm:p-4 text-center">
                        <h3 class="text-md font-extrabold text-gray-900 mb-1">${product.Name}</h3>
                        <p class="text-lg font-bold text-green-600 mb-2">${formattedPrice}</p>
                        
                        <div class="flex items-center justify-center space-x-2 mt-3">
                            <button class="qty-btn bg-gray-200 text-gray-700 p-2 rounded-full w-8 h-8 flex items-center justify-center font-bold hover:bg-gray-300 transition" data-action="decrement" data-id="${originalIndex}" onclick="event.stopPropagation()">-</button>
                            <input type="number" id="qty-${originalIndex}" 
                                   value="${cart[originalIndex] || 1}" 
                                   min="1" 
                                   max="99" 
                                   onchange="validateQty(this, ${originalIndex})" 
                                   onclick="event.stopPropagation()"
                                   class="w-12 text-center border border-gray-300 rounded-lg p-1 text-base font-semibold focus:border-indigo-500 focus:ring-indigo-500">
                            <button class="qty-btn bg-gray-200 text-gray-700 p-2 rounded-full w-8 h-8 flex items-center justify-center font-bold hover:bg-gray-300 transition" data-action="increment" data-id="${originalIndex}" onclick="event.stopPropagation()">+</button>
                            
                            <button id="select-icon-${originalIndex}" 
                                    class="selection-icon ml-3 ${isSelected ? 'selected' : ''}" 
                                    onclick="event.stopPropagation(); handleSelectionClick(${originalIndex});"
                                    ${selectionDisabled}>
                                ${isSelected 
                                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polyline points="20 6 9 17 4 12"></polyline></svg>` 
                                    : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ... (restantes das fun√ß√µes de formul√°rio)

    /**
     * L√≥gica para submeter o formul√°rio (enviar para o Google Apps Script)
     */
    elements.orderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (Object.keys(cart).length === 0) {
            showMessage("Selecione pelo menos um produto para encomendar.", 'error');
            return;
        }

        // Desativar o bot√£o e mostrar loading
        elements.submitButton.disabled = true;
        elements.submitButton.textContent = 'A Enviar Encomenda...';

        const formData = new FormData(elements.orderForm);
        const data = Object.fromEntries(formData.entries());
        
        try {
            // Enviar os dados para o Google Apps Script
            const response = await fetchWithRetry(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json'
                }
            }, 1);

            if (!response.ok) {
                throw new Error(`Erro de rede ou servidor: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.status === 'SUCCESS') {
                showMessage("Encomenda enviada com sucesso! Obrigado.", 'success');
                elements.orderForm.reset();
                cart = {}; // Limpa o carrinho
                updateCartDisplay();
                
                // Volta ao cat√°logo ap√≥s 3 segundos
                setTimeout(() => {
                    elements.backToCatalogue.click();
                }, 3000);

            } else {
                showMessage(`Erro ao processar a encomenda: ${result.message}`, 'error');
            }

        } catch (error) {
            console.error('Erro de Submiss√£o:', error);
            showMessage(`Erro inesperado ao enviar a encomenda. Tente novamente. (${error.message})`, 'error');
        } finally {
            // Reativar o bot√£o
            elements.submitButton.disabled = false;
            elements.submitButton.textContent = 'Finalizar Encomenda e Enviar Pedido';
        }
    });

    /**
     * L√≥gica de alternar entre Cat√°logo e Formul√°rio
     */
    function toggleSections(showCatalogue) {
        if (showCatalogue) {
            elements.catalogueSection.classList.remove('hidden');
            elements.orderSection.classList.add('hidden');
            // Garante que o cat√°logo √© renderizado corretamente ao voltar
            filterAndRender(); 
        } else {
            if (Object.keys(cart).length === 0) {
                showMessage("Selecione pelo menos um produto antes de finalizar a encomenda.", 'error');
                return;
            }
            elements.catalogueSection.classList.add('hidden');
            elements.orderSection.classList.remove('hidden');
            // Garante que o resumo do formul√°rio est√° atualizado
            updateCartDisplay();
        }
        // Rolagem suave para o topo da p√°gina
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Configurar listeners para alternar sec√ß√µes
    elements.viewOrderForm.addEventListener('click', () => toggleSections(false));
    elements.backToCatalogue.addEventListener('click', () => toggleSections(true));


    /**
     * Fun√ß√£o principal para carregar dados e inicializar a app.
     */
    async function initializeApp() {
        elements.loadingMessage.classList.remove('hidden');
        elements.loaderOverlay.classList.remove('hidden');
        elements.scriptUrlDisplay.textContent = `URL de Configura√ß√£o: ${GOOGLE_APPS_SCRIPT_URL}`;

        try {
            // Tenta obter dados do Google Apps Script
            const response = await fetchWithRetry(GOOGLE_APPS_SCRIPT_URL + "?action=getProducts");
            const data = await response.json();

            if (data.status === 'SUCCESS' && data.products && data.products.length > 0) {
                productCatalogue = data.products.map((p, index) => ({...p, originalIndex: index}));

                // üåü ALTERA√á√ÉO: Preenche a lista de categorias √∫nicas
                const allCategories = productCatalogue.map(product => getDisplayCategory(product));
                // Remove duplicados e vazios, e mant√©m a ordem de inser√ß√£o (ou ordena se preferir)
                uniqueCategories = [...new Set(allCategories.filter(c => c && c.trim()))].sort(); 

                renderFilterButtons();
                filterAndRender(); // Renderiza o cat√°logo com o filtro inicial ('Todos')
                elements.loadingMessage.classList.add('hidden');
                
            } else {
                elements.errorMessage.classList.remove('hidden');
                elements.loadingMessage.classList.add('hidden');
                console.error("Dados carregados inv√°lidos ou vazios:", data);
            }

        } catch (error) {
            elements.errorMessage.classList.remove('hidden');
            elements.loadingMessage.classList.add('hidden');
            console.error("Erro fatal ao carregar o cat√°logo:", error);
        } finally {
            // Ocultar loader ap√≥s o carregamento (sucesso ou falha)
            setTimeout(() => {
                elements.loaderOverlay.classList.add('hidden');
            }, 500); 
        }
    }

    // Inicializa a aplica√ß√£o ao carregar a p√°gina
    initializeApp();

    // Exportar fun√ß√µes para acesso global (para onclick/onchange no HTML)
    window.openLightbox = openLightbox;
    window.closeLightbox = closeLightbox;
    window.handleSelectionClick = handleSelectionClick;
    window.validateQty = validateQty;

</script>
