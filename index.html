import React, { useState, useEffect } from "react";
import { motion } from "framer-motion";

const SHEET_ID = "14qlE2JpofXNRAw0Yvgl86dBltK9NBjEK5rBKS2L5-s8";
const ENCOMENDAS_POST_URL = "https://script.google.com/macros/s/AKfycbxxBrqjBpM-N85EdZf1tPXMSU3lhleecBLWw9A1TWxbbL8mrpNrzNsSjmRdnWqpFTxj4A/exec";

export default function App() {
  const [page, setPage] = useState("catalogo");
  const [produtos, setProdutos] = useState([]);
  const [categoria, setCategoria] = useState("Todos");
  const [modal, setModal] = useState(null);
  const [carrinho, setCarrinho] = useState([]);
  const [form, setForm] = useState({ Nome: "", Email: "", Contacto: "", Mensagem: "" });

  useEffect(() => {
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&tq=&sheet=Produtos`)
      .then(res => res.text())
      .then(txt => JSON.parse(txt.substr(47).slice(0, -2)))
      .then(json => {
        const rows = json.table.rows.map(r => {
          const c = r.c.map(x => (x ? x.v : ""));
          return {
            ImageFile: c[0],
            Name: c[1],
            Descrição: c[2],
            Price: parseFloat(c[3]) || 0,
            category: c[4],
            Vendido: c[5],
          };
        });
        setProdutos(rows);
      });
  }, []);

  const categorias = ["Todos", ...new Set(produtos.map(p => p.category))];
  const filtrados = categoria === "Todos" ? produtos : produtos.filter(p => p.category === categoria);
  const total = carrinho.reduce((acc, item) => acc + item.Price * item.qtd, 0);

  const adicionarProduto = (produto, qtd) => {
    const existe = carrinho.find(p => p.Name === produto.Name);
    if (existe) {
      setCarrinho(carrinho.map(p => p.Name === produto.Name ? { ...p, qtd: p.qtd + qtd } : p));
    } else {
      setCarrinho([...carrinho, { ...produto, qtd }]);
    }
    setModal(null);
  };

  const enviarEncomenda = async (e) => {
    e.preventDefault();
    const data = {
      ...form,
      Quantidade: carrinho.reduce((acc, p) => acc + p.qtd, 0),
      ProdutosSelecionados: carrinho.map(p => `${p.Name} (x${p.qtd})`).join(", "),
      Mensagem: form.Mensagem,
    };
    try {
      const res = await fetch(ENCOMENDAS_POST_URL, {
        method: "POST",
        contentType: "application/json",
        body: JSON.stringify(data)
      });
      if (res.ok) alert("Encomenda enviada com sucesso!");
    } catch (err) {
      alert("Erro ao enviar encomenda.");
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-pink-100 to-white text-gray-800">
      <header className="p-4 flex items-center justify-between shadow bg-white sticky top-0 z-50">
        <div className="flex items-center gap-2">
          <img src="https://live.staticflickr.com/65535/54893023864_4910f0051e_n.jpg" alt="logo" className="w-10 h-10 rounded-full" />
          <h1 className="text-xl font-semibold">Estrela dos Desejos</h1>
        </div>
        <button onClick={() => setPage(page === "catalogo" ? "encomendas" : "catalogo")} className="text-sm px-4 py-2 bg-pink-500 text-white rounded-xl">
          {page === "catalogo" ? "Fazer Encomenda" : "Voltar ao Catálogo"}
        </button>
      </header>

      {page === "catalogo" && (
        <main className="p-4">
          <div className="flex flex-wrap gap-2 mb-4">
            {categorias.map(cat => (
              <button key={cat} onClick={() => setCategoria(cat)} className={`px-4 py-2 rounded-full border ${categoria === cat ? 'bg-pink-500 text-white' : 'bg-white'}`}>{cat}</button>
            ))}
          </div>

          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            {filtrados.map(prod => (
              <motion.div whileHover={{ scale: 1.03 }} key={prod.Name} className="bg-white rounded-2xl shadow p-3 flex flex-col relative">
                <img src={prod.ImageFile} alt={prod.Name} className="rounded-xl object-cover h-36" />
                <h3 className="font-semibold mt-2">{prod.Name}</h3>
                <p className="text-pink-600 font-bold">{prod.Price.toFixed(2)}€</p>
                <button onClick={() => setModal(prod)} className="absolute top-2 right-2 w-8 h-8 border-2 border-pink-500 rounded-full bg-white flex items-center justify-center hover:bg-pink-200">+</button>
              </motion.div>
            ))}
          </div>
        </main>
      )}

      {page === "encomendas" && (
        <main className="p-6 max-w-lg mx-auto">
          <h2 className="text-lg font-semibold mb-2">Formulário de Encomenda</h2>
          <form onSubmit={enviarEncomenda} className="flex flex-col gap-3">
            <input required placeholder="Nome" className="p-2 border rounded" value={form.Nome} onChange={e => setForm({ ...form, Nome: e.target.value })} />
            <input required placeholder="Email" type="email" className="p-2 border rounded" value={form.Email} onChange={e => setForm({ ...form, Email: e.target.value })} />
            <input required placeholder="Telefone" type="tel" className="p-2 border rounded" value={form.Contacto} onChange={e => setForm({ ...form, Contacto: e.target.value })} />
            <textarea placeholder="Mensagem (opcional)" className="p-2 border rounded" value={form.Mensagem} onChange={e => setForm({ ...form, Mensagem: e.target.value })}></textarea>

            {carrinho.length > 0 && (
              <div className="bg-white rounded-xl p-3 shadow">
                <h3 className="font-semibold mb-1">Carrinho:</h3>
                {carrinho.map((p, i) => (
                  <p key={i}>{p.Name} x{p.qtd}</p>
                ))}
                <p className="font-bold text-pink-600 mt-2">Total: {total.toFixed(2)}€</p>
              </div>
            )}

            <button className="bg-pink-600 text-white py-2 rounded-xl mt-2">Enviar Encomenda</button>
          </form>
          <div className="flex items-center justify-center mt-4 gap-2">
            <img src="https://whatthelogo.com/storage/logos/mbway-109591.png" alt="mbway" className="w-16" />
            <span className="font-semibold text-gray-700">935 106 743</span>
          </div>
        </main>
      )}

      {modal && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
          <motion.div initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="bg-white rounded-2xl p-4 max-w-xs text-center">
            <img src={modal.ImageFile} alt={modal.Name} className="rounded-xl h-52 w-full object-cover mx-auto" />
            <h3 className="font-semibold mt-3 text-lg">{modal.Name}</h3>
            {modal.Descrição && <p className="text-sm text-gray-600 mt-2">{modal.Descrição}</p>}
            <p className="text-pink-600 font-bold mt-3">{modal.Price.toFixed(2)}€</p>
            <div className="flex items-center justify-center mt-4 gap-4">
              <button onClick={() => adicionarProduto(modal, -1)} disabled={modal.qtd <= 1} className="bg-pink-100 px-3 py-1 rounded-full text-pink-700">-</button>
              <span className="text-lg font-semibold">{modal.qtd || 1}</span>
              <button onClick={() => adicionarProduto(modal, 1)} className="bg-pink-100 px-3 py-1 rounded-full text-pink-700">+</button>
            </div>
            <button onClick={() => adicionarProduto(modal, modal.qtd || 1)} className="mt-4 bg-pink-500 text-white py-2 px-4 rounded-xl w-full">Confirmar</button>
            <button onClick={() => setModal(null)} className="mt-2 text-gray-500 text-sm">Cancelar</button>
          </motion.div>
        </div>
      )}
    </div>
  );
}
